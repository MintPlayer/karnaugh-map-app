<bs-container class="d-block p-4">
  <header class="mb-4">
    <h1 class="h2">Karnaugh Map Solver</h1>
    <p class="text-muted">
      Interactive Boolean logic minimization using the Quine-McCluskey algorithm
    </p>
  </header>

  <!-- Variable Controls -->
  <bs-card class="d-block mb-3">
    <bs-card-header>
      <h5 class="card-title mb-0">Variables</h5>
    </bs-card-header>
    <bs-grid>
      <div bsRow class="g-3 align-items-end">
        <div [col]>
          <label class="form-label me-3">Number of Variables</label>
          <bs-button-group>
            <button
              class="btn btn-outline-secondary"
              (click)="removeVariable()"
              [disabled]="inputVariables.length <= 1"
            >
              <span>-</span>
            </button>
            <span class="btn btn-outline-secondary disabled">
              {{ inputVariables.length }}
            </span>
            <button
              class="btn btn-outline-secondary"
              (click)="addVariable()"
            >
              <span>+</span>
            </button>
          </bs-button-group>
        </div>

        <div [col]>
          <label class="form-label">Variable Names</label>
          <div class="d-flex flex-wrap gap-2">
            @for (variable of inputVariables; track $index) {
              <input
                type="text"
                class="form-control form-control-sm"
                style="width: 60px"
                [value]="variable"
                (blur)="updateVariableName($index, $event)"
                maxlength="3"
              />
            }
          </div>
        </div>

        <div [col]>
          <label class="form-label">Output</label>
          <input
            type="text"
            class="form-control form-control-sm"
            style="width: 60px"
            [(ngModel)]="outputVariable"
            maxlength="3"
          />
        </div>
      </div>
    </bs-grid>
  </bs-card>

  <!-- Mode Toggle -->
  <bs-card class="d-block mb-3">
    <bs-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Karnaugh Map</h5>
        <bs-button-group class="btn-group-sm">
          <button
            class="btn"
            [class.btn-primary]="mode === EEditMode.Edit"
            [class.btn-outline-primary]="mode !== EEditMode.Edit"
            (click)="setMode(EEditMode.Edit)"
          >
            Edit
          </button>
          <button
            class="btn"
            [class.btn-primary]="mode === EEditMode.Solve"
            [class.btn-outline-primary]="mode !== EEditMode.Solve"
            (click)="setMode(EEditMode.Solve)"
          >
            Solve
          </button>
        </bs-button-group>
      </div>
    </bs-card-header>
    <div class="mb-3 text-muted small">
      @if (mode === EEditMode.Edit) {
        <span>Click cells to toggle values: empty → 0 → 1 → X (don't care) → empty</span>
      } @else {
        <span>Click cells to select them for solving</span>
      }
    </div>

    <!-- Karnaugh Map Component -->
    <div class="d-flex justify-content-center mb-4">
      <mintplayer-karnaugh-map
        #kmap
        [inputVariables]="inputVariables"
        [outputVariable]="outputVariable"
        [mode]="mode"
        [cellSize]="48"
        [highlightedLoopIndex]="effectiveLoopIndex"
        [highlightedLoopType]="effectiveLoopType"
        (solved)="onSolved($event)"
      />
    </div>

    <!-- Action Buttons -->
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-success" (click)="solve()">
        Solve Automatically
      </button>
      <button class="btn btn-outline-primary" (click)="randomFill()">
        Random Fill
      </button>
      <button class="btn btn-outline-secondary" (click)="clear()">
        Clear
      </button>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" (click)="exportState()">
          Export
        </button>
        <label class="btn btn-outline-secondary btn-sm mb-0">
          Import
          <input
            type="file"
            accept=".json"
            class="d-none"
            (change)="importState($event)"
          />
        </label>
      </div>
    </div>
  </bs-card>

  <!-- Results -->
  @if (isSolved) {
    <bs-card class="d-block mb-3">
      <bs-card-header>
        <h5 class="card-title mb-0">Result</h5>
      </bs-card-header>
      <div class="mb-3">
        <label class="form-label fw-semibold">Sum of Products (SOP):</label>
        <div class="d-flex gap-2 align-items-center">
          <code class="expression flex-grow-1 p-2 bg-light rounded">
            @if (onesTerms.length === 0) {
              {{ outputVariable }} = 0
            } @else {
              {{ outputVariable }} =
              @for (term of onesTerms; track $index; let isLast = $last) {
                <span
                  class="term"
                  [class.active]="isTermActive($index, 'ones')"
                  [class.selected]="isTermSelected($index, 'ones')"
                  (mouseenter)="hoverTerm($index, 'ones')"
                  (mouseleave)="unhoverTerm()"
                  (click)="toggleSelectTerm($index, 'ones')"
                >{{ term }}</span>@if (!isLast) { + }
              }
            }
          </code>
          <button
            class="btn btn-sm btn-outline-secondary"
            (click)="copyExpression(onesExpression)"
            title="Copy to clipboard"
          >
            Copy
          </button>
        </div>
      </div>

      @if (zerosTerms.length > 0) {
        <div>
          <label class="form-label fw-semibold">Complement (zeros):</label>
          <div class="d-flex gap-2 align-items-center">
            <code class="expression flex-grow-1 p-2 bg-light rounded">
              {{ outputVariable }}' =
              @for (term of zerosTerms; track $index; let isLast = $last) {
                <span
                  class="term"
                  [class.active]="isTermActive($index, 'zeros')"
                  [class.selected]="isTermSelected($index, 'zeros')"
                  (mouseenter)="hoverTerm($index, 'zeros')"
                  (mouseleave)="unhoverTerm()"
                  (click)="toggleSelectTerm($index, 'zeros')"
                >{{ term }}</span>@if (!isLast) { + }
              }
            </code>
            <button
              class="btn btn-sm btn-outline-secondary"
              (click)="copyExpression(zerosExpression)"
              title="Copy to clipboard"
            >
              Copy
            </button>
          </div>
        </div>
      }
    </bs-card>
  }

  <!-- Instructions -->
  <bs-card class="d-block mb-3">
    <bs-card-header>
      <h5 class="card-title mb-0">Instructions</h5>
    </bs-card-header>
    <ul class="mb-0">
      <li>Use <strong>+/-</strong> buttons to add or remove variables</li>
      <li>Click on cells to toggle their values (0, 1, X for don't care)</li>
      <li>Use <strong>Random Fill</strong> to populate the map with random values</li>
      <li>
        Keyboard shortcuts (when map is focused):
        <ul>
          <li><kbd>Arrow keys</kbd> - Navigate cells</li>
          <li><kbd>0</kbd>, <kbd>1</kbd>, <kbd>X</kbd> - Set cell value directly</li>
          <li><kbd>Space</kbd> or <kbd>Enter</kbd> - Toggle cell value</li>
          <li><kbd>Delete</kbd> - Clear cell</li>
        </ul>
      </li>
      <li>Click <strong>Solve Automatically</strong> to minimize the Boolean function</li>
      <li>The small numbers in cells show the minterm index</li>
    </ul>
  </bs-card>

  <!-- GitHub -->
  <bs-card class="d-block mb-3">
    <div class="d-flex align-items-center gap-3">
        <svg height="32" viewBox="0 0 16 16" width="32" class="flex-shrink-0">
          <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
        <div class="flex-grow-1">
          <h5 class="card-title mb-1">Open Source</h5>
          <p class="card-text text-muted mb-0">
            This project is open source. View the code, report issues, or contribute on GitHub.
          </p>
        </div>
      <a
        href="https://github.com/MintPlayer/karnaugh-map-app"
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-outline-secondary"
      >
        View on GitHub
      </a>
    </div>
  </bs-card>
</bs-container>
